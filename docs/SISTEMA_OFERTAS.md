# Sistema de Ofertas Promocionales

**Fecha:** 2025-10-19
**Versi√≥n:** 1.0.0
**Estado:** Backend completado ‚ö†Ô∏è (ver nota sobre integraci√≥n con Admin)

---

## üìã Resumen

Sistema completo de gesti√≥n de ofertas promocionales (anuncios con descuentos) para colaboradores de La P√∫blica. Incluye gesti√≥n de stock, cupones de descuento, fechas de vigencia y segmentaci√≥n por grupos.

---

## üéØ Caracter√≠sticas Principales

### Gesti√≥n de Ofertas
- ‚úÖ CRUD completo de ofertas
- ‚úÖ Control de stock y disponibilidad
- ‚úÖ Sistema de precios (original, con descuento, porcentaje)
- ‚úÖ Fechas de inicio y fin de vigencia
- ‚úÖ Medios (imagen principal, galer√≠a, video promocional)
- ‚úÖ Segmentaci√≥n por grupos espec√≠ficos
- ‚úÖ Categorizaci√≥n
- ‚úÖ Estado activo/pausado

### Sistema de Cupones
- ‚úÖ Creaci√≥n de cupones de descuento
- ‚úÖ C√≥digo √∫nico por cup√≥n
- ‚úÖ Descuento porcentual adicional
- ‚úÖ L√≠mite de usos configurables
- ‚úÖ Fechas de validez del cup√≥n
- ‚úÖ Validaci√≥n en tiempo real
- ‚úÖ Desactivaci√≥n manual de cupones

### Permisos y Roles
- **Crear ofertas:** Colaboradores, Admin, Superadmin
- **Ver ofertas:** P√∫blico
- **Aplicar cupones:** Usuarios autenticados
- **Editar/Eliminar:** Solo creador o admin

---

## üóÇÔ∏è Modelo de Datos

### Oferta (Offer)

```typescript
{
  // Informaci√≥n b√°sica
  title: string,                    // T√≠tulo de la oferta
  slug: string,                     // URL amigable (auto-generado)
  description: string,              // Descripci√≥n detallada

  // Precios
  originalPrice: number,            // Precio original
  discountedPrice: number,          // Precio con descuento
  discountPercentage: number,       // % de descuento (auto-calculado)

  // Vigencia
  startDate: Date,                  // Fecha de inicio
  endDate: Date,                    // Fecha de fin

  // Stock
  stock: number,                    // Stock inicial
  remainingStock: number,           // Stock disponible

  // Detalles
  included: string[],               // Qu√© incluye
  notIncluded: string[],            // Qu√© NO incluye
  usageInstructions: string,        // Instrucciones de uso

  // Medios
  mainImage: string,                // Imagen principal (URL)
  gallery: string[],                // Galer√≠a de im√°genes
  videoUrl: string,                 // Video promocional (opcional)

  // Relaciones
  createdBy: ObjectId,              // Creador (User)
  company: ObjectId,                // Empresa (opcional)
  targetGroups: ObjectId[],         // Grupos espec√≠ficos
  category: ObjectId,               // Categor√≠a

  // Cupones
  coupons: ICoupon[],               // Array de cupones

  // Estado
  isActive: boolean,                // Activa/Inactiva
  isPaused: boolean,                // Pausada
  views: number,                    // N√∫mero de visualizaciones
  purchases: number,                // N√∫mero de compras

  // Virtuals
  isCurrentlyActive: boolean,       // ¬øEst√° activa ahora?
  isSoldOut: boolean,               // ¬øAgotada?
  isExpired: boolean                // ¬øExpirada?
}
```

### Cup√≥n (Coupon)

```typescript
{
  code: string,                     // C√≥digo del cup√≥n (uppercase)
  discountPercentage: number,       // % de descuento adicional
  maxUses: number,                  // M√°ximo de usos (opcional)
  usedCount: number,                // Usos realizados
  validFrom: Date,                  // V√°lido desde
  validUntil: Date,                 // V√°lido hasta
  isActive: boolean                 // Activo/Inactivo
}
```

---

## üîå API Endpoints

### Rutas P√∫blicas

#### Listar ofertas
```
GET /api/offers
Query params:
  - page: n√∫mero de p√°gina (default: 1)
  - limit: ofertas por p√°gina (default: 12)
  - category: filtrar por categor√≠a
  - createdBy: filtrar por creador
  - company: filtrar por empresa
  - active: true/false (solo ofertas activas)
  - search: b√∫squeda de texto

Response:
{
  success: true,
  offers: [...],
  pagination: {
    page: 1,
    limit: 12,
    total: 50,
    pages: 5
  }
}
```

#### Obtener oferta por slug
```
GET /api/offers/:slug

Response:
{
  success: true,
  offer: {
    _id: "...",
    title: "Oferta especial...",
    slug: "oferta-especial",
    ...
    createdBy: { firstName, lastName, email, avatar },
    company: { name, logo, description },
    category: { name },
    targetGroups: [{ name, description }]
  }
}
```

### Rutas Protegidas (Autenticado)

#### Validar cup√≥n
```
POST /api/offers/:id/coupons/validate
Body: { code: "DESCUENTO2024" }

Response:
{
  success: true,
  message: "Cup√≥ v√†lid",
  coupon: {
    code: "DESCUENTO2024",
    discountPercentage: 10
  },
  pricing: {
    originalPrice: 100,
    baseDiscountedPrice: 80,     // Precio con descuento base
    couponDiscount: 8,            // Descuento adicional del cup√≥n
    finalPrice: 72,               // Precio final
    totalDiscount: 28,            // Descuento total
    totalDiscountPercentage: 28   // % total
  }
}
```

### Rutas para Colaboradores/Admin

#### Crear oferta
```
POST /api/offers
Headers: Authorization: Bearer <token>
Roles: colaborador, admin, superadmin

Body:
{
  title: "Oferta especial de verano",
  description: "Descripci√≥n completa...",
  originalPrice: 100,
  discountedPrice: 70,
  startDate: "2025-06-01",
  endDate: "2025-08-31",
  stock: 50,
  included: ["Servicio 1", "Servicio 2"],
  notIncluded: ["Servicio 3"],
  usageInstructions: "Instrucciones...",
  mainImage: "https://...",
  gallery: ["https://...", "https://..."],
  videoUrl: "https://youtube.com/...",
  company: "company_id",
  targetGroups: ["group_id_1", "group_id_2"],
  category: "category_id"
}

Response:
{
  success: true,
  message: "Oferta creada correctament",
  offer: {...}
}
```

#### Actualizar oferta
```
PUT /api/offers/:id
Headers: Authorization: Bearer <token>
Roles: colaborador (owner), admin, superadmin

Body: (campos parciales permitidos)

Response:
{
  success: true,
  message: "Oferta actualitzada correctament",
  offer: {...}
}
```

#### Eliminar oferta
```
DELETE /api/offers/:id
Headers: Authorization: Bearer <token>
Roles: colaborador (owner), admin, superadmin

Response:
{
  success: true,
  message: "Oferta eliminada correctament"
}
```

#### Pausar/Reanudar oferta
```
PATCH /api/offers/:id/toggle-pause
Headers: Authorization: Bearer <token>
Roles: colaborador (owner), admin, superadmin

Response:
{
  success: true,
  message: "Oferta pausada" | "Oferta reactivada",
  offer: {
    id: "...",
    isPaused: true|false
  }
}
```

#### Mis ofertas
```
GET /api/offers/my-offers
Headers: Authorization: Bearer <token>
Roles: colaborador, admin, superadmin
Query params:
  - page, limit (paginaci√≥n)
  - status: active|paused|inactive

Response:
{
  success: true,
  offers: [...],
  pagination: {...}
}
```

#### Crear cup√≥n
```
POST /api/offers/:id/coupons
Headers: Authorization: Bearer <token>
Roles: colaborador (owner), admin, superadmin

Body:
{
  code: "SUMMER2024",
  discountPercentage: 15,
  maxUses: 100,
  validFrom: "2025-06-01",
  validUntil: "2025-08-31"
}

Response:
{
  success: true,
  message: "Cup√≥ creat correctament",
  coupon: {...}
}
```

#### Desactivar cup√≥n
```
PATCH /api/offers/:id/coupons/:code/deactivate
Headers: Authorization: Bearer <token>
Roles: colaborador (owner), admin, superadmin

Response:
{
  success: true,
  message: "Cup√≥ desactivat correctament"
}
```

---

## üîí Validaciones

### Oferta
- ‚úÖ T√≠tulo: 3-200 caracteres
- ‚úÖ Descripci√≥n: 10-5000 caracteres
- ‚úÖ Precio original ‚â• 0
- ‚úÖ Precio con descuento ‚â• 0
- ‚úÖ Precio con descuento < Precio original
- ‚úÖ Stock ‚â• 1
- ‚úÖ Fecha fin > Fecha inicio
- ‚úÖ Imagen principal requerida (URL v√°lida)
- ‚úÖ Galer√≠a: array de URLs v√°lidas
- ‚úÖ Video: URL v√°lida (opcional)

### Cup√≥n
- ‚úÖ C√≥digo: 3-20 caracteres (auto-uppercase)
- ‚úÖ Descuento: 0-100%
- ‚úÖ M√°ximo usos ‚â• 1 (opcional)
- ‚úÖ Fecha v√°lido hasta > Fecha v√°lido desde

---

## üßÆ L√≥gica de Negocio

### Slug Auto-generado
El slug se genera autom√°ticamente del t√≠tulo:
- Normalizaci√≥n NFD (elimina acentos)
- Lowercase
- Caracteres especiales removidos
- Espacios ‚Üí guiones
- Si existe, agrega contador: `oferta-especial-1`, `oferta-especial-2`

### C√°lculo de Descuento
```typescript
discountPercentage = Math.round(
  ((originalPrice - discountedPrice) / originalPrice) * 100
)
```

### Estado "Actualmente Activa"
Una oferta est√° actualmente activa si cumple TODO lo siguiente:
- `isActive === true`
- `isPaused === false`
- `startDate <= now`
- `endDate >= now`
- `remainingStock > 0`

### Aplicaci√≥n de Cup√≥n
```typescript
additionalDiscount = (discountedPrice * couponDiscountPercentage) / 100
finalPrice = discountedPrice - additionalDiscount
totalDiscount = originalPrice - finalPrice
totalDiscountPercentage = Math.round((totalDiscount / originalPrice) * 100)
```

---

## üìÅ Archivos Creados

### Backend
- `src/offer.model.ts` (320 l√≠neas) - Modelo con validaciones
- `src/offer.controller.ts` (550 l√≠neas) - Controladores CRUD + cupones
- `src/offer.routes.ts` (70 l√≠neas) - Definici√≥n de rutas
- `src/server.ts` - Importaci√≥n y registro de rutas

---

## üöÄ Pr√≥ximos Pasos (Pendientes)

### Backend
- [ ] Tests automatizados con Jest
- [ ] Script de seed para ofertas de prueba
- [ ] Endpoint para estad√≠sticas de ofertas
- [ ] Endpoint para historial de ventas
- [ ] Notificaciones cuando se agota el stock

### Frontend
- [ ] P√°gina p√∫blica de listado de ofertas
- [ ] P√°gina de detalle de oferta
- [ ] Formulario de creaci√≥n/edici√≥n (colaboradores)
- [ ] Panel "Mis Ofertas" (colaboradores)
- [ ] Gesti√≥n de cupones (modal/secci√≥n)
- [ ] Componente de validaci√≥n de cup√≥n
- [ ] Filtros avanzados
- [ ] Integraci√≥n con sistema de pago (futuro)

---

## üí° Casos de Uso

### Colaborador crea oferta
1. Colaborador accede a "Mis Ofertas"
2. Click en "Nueva Oferta"
3. Completa formulario con todos los datos
4. Sube imagen principal y galer√≠a
5. Define precios y stock
6. Selecciona fechas de vigencia
7. Opcionalmente a√±ade grupos espec√≠ficos
8. Guarda ‚Üí Oferta creada con `isActive: true`

### Colaborador crea cup√≥n
1. Desde "Mis Ofertas" edita una oferta
2. Click en "Gestionar Cupones"
3. Click "Nuevo Cup√≥n"
4. Define c√≥digo (ej: VERANO2024)
5. Define descuento adicional (15%)
6. Define l√≠mite de usos (100)
7. Define fechas de validez
8. Guarda ‚Üí Cup√≥n creado y disponible

### Usuario aplica cup√≥n
1. Usuario ve oferta que le interesa
2. Ingresa c√≥digo de cup√≥n en el campo
3. Click "Aplicar cup√≥n"
4. Sistema valida: activo, fechas, usos
5. Si v√°lido ‚Üí Muestra precio final recalculado
6. Usuario procede a "comprar" (futuro: integraci√≥n pago)

### Oferta se agota
- `remainingStock` llega a 0
- `isSoldOut` = true
- Oferta ya no aparece como disponible
- No se pueden aplicar cupones
- Colaborador recibe notificaci√≥n (futuro)

---

## üé® Dise√±o de UI (Propuesta)

### Listado de Ofertas (P√∫blico)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Imagen]                           ‚îÇ
‚îÇ T√≠tulo de la oferta                ‚îÇ
‚îÇ -30% ‚Üê Badge descuento             ‚îÇ
‚îÇ 70‚Ç¨ [100‚Ç¨ tachado]                 ‚îÇ
‚îÇ Stock: 25/50 disponibles           ‚îÇ
‚îÇ V√°lido hasta: 31/08/2025           ‚îÇ
‚îÇ [Ver Detalles]                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Detalle de Oferta
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Galer√≠a de im√°genes] [Video]            ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ T√≠tulo de la oferta                      ‚îÇ
‚îÇ Descripci√≥n completa...                  ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ Precio: 70‚Ç¨ [100‚Ç¨ tachado] (-30%)        ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ ‚úÖ Qu√© incluye:                          ‚îÇ
‚îÇ    ‚Ä¢ Servicio 1                          ‚îÇ
‚îÇ    ‚Ä¢ Servicio 2                          ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ ‚ùå Qu√© NO incluye:                       ‚îÇ
‚îÇ    ‚Ä¢ Servicio 3                          ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üìù Instrucciones de uso:                 ‚îÇ
‚îÇ Texto con instrucciones...               ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üéüÔ∏è ¬øTienes un cup√≥n?                    ‚îÇ
‚îÇ [C√ìDIGO___] [Aplicar]                    ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ Stock: 25 disponibles                    ‚îÇ
‚îÇ V√°lido: 01/06/2025 - 31/08/2025          ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ [Comprar Ahora]                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Panel "Mis Ofertas" (Colaborador)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Mis Ofertas                   [+ Nueva]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üü¢ Oferta especial de verano             ‚îÇ
‚îÇ    Stock: 25/50 | Vistas: 234            ‚îÇ
‚îÇ    [Pausar] [Editar] [Cupones] [Stats]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚è∏Ô∏è  Oferta de invierno (PAUSADA)         ‚îÇ
‚îÇ    Stock: 10/30 | Vistas: 120            ‚îÇ
‚îÇ    [Reanudar] [Editar] [Cupones]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è Nota Importante: Integraci√≥n con Admin

**Estado actual:** La integraci√≥n de ofertas en el panel de administraci√≥n (`/api/admin-data/promotional-offers`) est√° **temporalmente deshabilitada** debido a problemas de referencias circulares en el modelo.

**Detalles:**
- ‚úÖ **Todos los endpoints de ofertas funcionan correctamente** (`/api/offers/*`)
- ‚ùå **Gesti√≥n desde Admin Data est√° pendiente** (no bloquea funcionalidad principal)
- üìã **Documento de seguimiento:** [docs/PENDIENTE_OFERTAS_ADMIN.md](PENDIENTE_OFERTAS_ADMIN.md)

**Funcionalidades disponibles:**
- Crear, editar, eliminar ofertas ‚úÖ
- Listar ofertas (p√∫blico y privado) ‚úÖ
- Sistema de cupones completo ‚úÖ
- Control de stock ‚úÖ
- Todas las operaciones de colaboradores ‚úÖ

**Funcionalidades pendientes:**
- Listar ofertas desde panel de administraci√≥n ‚è≥
- Operaciones bulk en ofertas desde admin ‚è≥
- Asignaci√≥n de autor/categor√≠a desde admin ‚è≥

**Soluci√≥n propuesta:**
Implementar lazy loading del modelo Offer en `adminData.controller.ts` para evitar referencias circulares durante la inicializaci√≥n de Mongoose.

---

**√öltima actualizaci√≥n:** 2025-10-19
